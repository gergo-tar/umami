name: Build and Deploy Umami

on:
  push:  
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:  
    runs-on: ubuntu-latest

    steps:
      - name:  Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version:  10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client for PostgreSQL
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
          DATABASE_TYPE: "postgresql"
        run: pnpm run build-db

      - name: Build application
        env:
          NODE_OPTIONS: --max-old-space-size=4096
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
          DATABASE_TYPE:  "postgresql"
          SKIP_DB_CHECK: 1
        run: |
          pnpm run build-tracker
          pnpm run build-geo
          pnpm exec next build --turbo
        
      - name:  Verify build artifacts
        run: |
          echo "=== Build artifacts ==="
          ls -la .next 2>/dev/null && echo "✓ .next exists" || echo "✗ .next missing"
          ls -la public/script.js 2>/dev/null && echo "✓ public/script.js exists" || echo "✗ public/script.js missing"
          ls -la geo 2>/dev/null && echo "✓ geo exists" || echo "✗ geo missing"
          ls -la generated 2>/dev/null && echo "✓ generated exists" || echo "✗ generated missing"
          ls -la src/generated 2>/dev/null && echo "✓ src/generated exists" || echo "✗ src/generated missing"
          echo "=== Sizes ==="
          du -sh .next public/script.js geo generated src/generated 2>/dev/null || true

      - name: Create tar archive of build artifacts
        run: |
          tar -czf build-artifacts.tar.gz .next public/script.js geo generated src/generated

      - name:  Upload build artifacts
        uses: actions/upload-artifact@v4
        with: 
          name:  umami-build-${{ github.sha }}
          path: build-artifacts.tar.gz
          retention-days: 30

  deploy:
    needs:  build
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: umami-build-${{ github.sha }}

      - name: Extract build artifacts
        run: |
          tar -xzf build-artifacts.tar.gz
          echo "=== Extracted artifacts ==="
          ls -la
          echo "=== File count ==="
          find .next -type f 2>/dev/null | wc -l

      - name: Deploy to Forge via rsync
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.FORGE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.FORGE_HOST }} >> ~/.ssh/known_hosts
          
          # Deploy artifacts to correct locations
          rsync -avz --delete .next/ ${{ secrets.FORGE_USER }}@${{ secrets.FORGE_HOST }}:${{ secrets.FORGE_PATH }}/.next/
          rsync -avz geo/ ${{ secrets.FORGE_USER }}@${{ secrets.FORGE_HOST }}:${{ secrets.FORGE_PATH }}/geo/
          rsync -avz public/script.js ${{ secrets.FORGE_USER }}@${{ secrets.FORGE_HOST }}:${{ secrets.FORGE_PATH }}/public/
          rsync -avz generated/ ${{ secrets.FORGE_USER }}@${{ secrets.FORGE_HOST }}:${{ secrets.FORGE_PATH }}/generated/
          rsync -avz src/generated/ ${{ secrets.FORGE_USER }}@${{ secrets.FORGE_HOST }}:${{ secrets.FORGE_PATH }}/src/generated/

      - name: Regenerate Prisma client on server (ensure PostgreSQL compatibility)
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.FORGE_USER }}@${{ secrets.FORGE_HOST }} << 'EOF'
            cd ${{ secrets.FORGE_PATH }}
            pnpm run build-db
          EOF

      - name: Trigger Forge Deploy Script
        run:  curl -X POST "${{ secrets.FORGE_DEPLOY_URL }}"
